<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Personal Expense Tracker</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div class="compact-container">
        <!-- Top Header Row -->
        <header class="top-header">
            <h1>Personal Expense Tracker</h1>
            <div class="top-actions">
                <button id="darkModeToggle" onclick="toggleDarkMode()" class="icon-btn-top">
                    <span id="darkModeIcon">ðŸŒ™</span>
                </button>
                <button id="voiceBtn" onclick="startVoiceRecognition()" class="action-btn-top">
                    ðŸŽ¤ Voice Add
                </button>
                <button onclick="toggleAddForm()" class="action-btn-top" id="addBtn">
                    + Add Expense
                </button>
                <button class="icon-btn-top">ðŸ‘¤</button>
            </div>
        </header>

        <div class="note-text">Integrate with user login system â†‘</div>

        <!-- Voice Status (Compact) -->
        <div id="voiceStatus" class="voice-inline" style="display: none;">
            <span class="pulse-icon">ðŸŽ¤</span>
            <span>Listening...</span>
            <button onclick="stopVoiceRecognition()" class="close-btn">âœ•</button>
        </div>

        <!-- Voice Result -->
        <div id="voiceResult" class="voice-inline" style="display: none;">
            <span><strong>$<span id="voiceAmount">0</span></strong> â€¢ <span id="voiceCategory">-</span> â€¢ <span id="voiceDescription">-</span></span>
            <div>
                <button onclick="confirmVoiceExpense()" class="mini-btn success">âœ“</button>
                <button onclick="cancelVoiceExpense()" class="mini-btn cancel">âœ•</button>
            </div>
        </div>

        <!-- Inline Add Form -->
        <div id="expenseForm" class="add-form-inline" style="display: none;">
            <input type="hidden" id="editExpenseId">
            <input type="number" id="amount" step="0.01" placeholder="Amount" class="input-compact">
            <select id="category" class="input-compact">
                <option>Food & Dining</option>
                <option>Transportation</option>
                <option>Shopping</option>
                <option>Entertainment</option>
                <option>Bills & Utilities</option>
                <option>Healthcare</option>
                <option>Education</option>
                <option>Other</option>
            </select>
            <input type="text" id="description" placeholder="Description" class="input-compact">
            <input type="date" id="date" class="input-compact">
            <button onclick="saveExpense()" class="mini-btn success" id="saveBtn">Save</button>
            <button onclick="toggleAddForm()" class="mini-btn cancel">Cancel</button>
        </div>

        <!-- Stats Row -->
        <div class="stats-row">
            <div class="stat-box">
                <select id="monthSelector" class="month-select"></select>
            </div>
            <div class="stat-box">
                <div class="stat-label">Income</div>
                <input type="number" id="monthlyIncome" step="0.01" placeholder="0" class="stat-input">
            </div>
            <div class="stat-box">
                <div class="stat-label">Total Spending</div>
                <div class="stat-value" id="totalSpending">$0.00</div>
            </div>
            <div class="stat-box">
                <div class="stat-label">Transactions</div>
                <div class="stat-value" id="totalTransactions">0</div>
            </div>
            <div class="stat-box highlight">
                <div class="stat-label">Saved</div>
                <div class="stat-value" id="savedAmount">$0.00</div>
                <div class="stat-percentage" id="savingsPercentage">0%</div>
            </div>
        </div>

        <!-- Main Content Grid -->
        <div class="content-grid">
            <!-- Recent Transactions (Full Width Top) -->
            <div class="transactions-box">
                <h3>Recent Transactions</h3>
                <div id="transactionsList" class="transactions-scroll"></div>
            </div>

            <!-- Charts Row -->
            <div class="chart-box">
                <h3>Spending by Category</h3>
                <canvas id="categoryChart"></canvas>
            </div>
            <div class="chart-box">
                <h3>Monthly Trend</h3>
                <canvas id="trendChart"></canvas>
            </div>
        </div>
    </div>

    <script>
        let expenses = [];
        let categoryChart = null;
        let trendChart = null;
        let isEditMode = false;
        let recognition = null;
        let voiceData = null;

        document.addEventListener('DOMContentLoaded', function() {
            const today = new Date();
            document.getElementById('date').valueAsDate = today;
            generateMonthOptions();
            document.getElementById('monthSelector').addEventListener('change', updateDisplay);
            document.getElementById('monthlyIncome').addEventListener('change', saveMonthlyIncome);
            document.getElementById('monthlyIncome').addEventListener('blur', saveMonthlyIncome);
            loadDarkModePreference();
            initVoiceRecognition();
            loadExpenses();
        });

        function generateMonthOptions() {
            const selector = document.getElementById('monthSelector');
            const today = new Date();
            const currentYear = today.getFullYear();
            const currentMonth = today.getMonth();
            const months = [];
            for (let i = -12; i <= 12; i++) {
                const date = new Date(currentYear, currentMonth + i, 1);
                const yearMonth = date.toISOString().slice(0, 7);
                const monthName = date.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
                months.push({ value: yearMonth, label: monthName });
            }
            selector.innerHTML = months.map(m =>
                `<option value="${m.value}" ${m.value === today.toISOString().slice(0, 7) ? 'selected' : ''}>${m.label}</option>`
            ).join('');
        }

        function toggleDarkMode() {
            document.body.classList.toggle('dark-mode');
            const isDark = document.body.classList.contains('dark-mode');
            document.getElementById('darkModeIcon').textContent = isDark ? 'â˜€ï¸' : 'ðŸŒ™';
            localStorage.setItem('darkMode', isDark ? 'enabled' : 'disabled');
            updateDisplay();
        }

        function loadDarkModePreference() {
            const darkMode = localStorage.getItem('darkMode');
            if (darkMode === 'enabled') {
                document.body.classList.add('dark-mode');
                document.getElementById('darkModeIcon').textContent = 'â˜€ï¸';
            }
        }

        function toggleAddForm() {
            const form = document.getElementById('expenseForm');
            const isVisible = form.style.display !== 'none';
            form.style.display = isVisible ? 'none' : 'flex';
            document.getElementById('addBtn').textContent = isVisible ? '+ Add Expense' : 'âœ• Close';
            if (!isVisible) {
                isEditMode = false;
                document.getElementById('editExpenseId').value = '';
                document.getElementById('amount').value = '';
                document.getElementById('category').value = 'Food & Dining';
                document.getElementById('description').value = '';
                document.getElementById('date').valueAsDate = new Date();
                document.getElementById('saveBtn').textContent = 'Save';
            }
        }

        function loadMonthlyIncome() {
            const selectedMonth = document.getElementById('monthSelector').value;
            const incomeKey = 'income_' + selectedMonth;
            const savedIncome = localStorage.getItem(incomeKey);
            document.getElementById('monthlyIncome').value = savedIncome || '';
        }

        function saveMonthlyIncome() {
            const selectedMonth = document.getElementById('monthSelector').value;
            const income = document.getElementById('monthlyIncome').value;
            const incomeKey = 'income_' + selectedMonth;
            if (income) {
                localStorage.setItem(incomeKey, income);
            } else {
                localStorage.removeItem(incomeKey);
            }
            updateDisplay();
        }

        function initVoiceRecognition() {
            if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                recognition = new SpeechRecognition();
                recognition.continuous = false;
                recognition.interimResults = false;
                recognition.lang = 'en-US';
                recognition.onresult = function(event) {
                    parseVoiceCommand(event.results[0][0].transcript);
                };
                recognition.onerror = function(event) {
                    document.getElementById('voiceStatus').style.display = 'none';
                };
                recognition.onend = function() {
                    document.getElementById('voiceStatus').style.display = 'none';
                };
            } else {
                document.getElementById('voiceBtn').disabled = true;
            }
        }

        function startVoiceRecognition() {
            if (!recognition) return;
            document.getElementById('voiceStatus').style.display = 'flex';
            document.getElementById('voiceResult').style.display = 'none';
            document.getElementById('expenseForm').style.display = 'none';
            document.getElementById('addBtn').textContent = '+ Add Expense';
            try { recognition.start(); } catch (e) {}
        }

        function stopVoiceRecognition() {
            if (recognition) recognition.stop();
            document.getElementById('voiceStatus').style.display = 'none';
        }

        function parseVoiceCommand(transcript) {
            const text = transcript.toLowerCase();
            const amountMatch = text.match(/(\d+(?:\.\d{1,2})?)/);
            const amount = amountMatch ? parseFloat(amountMatch[1]) : 0;
            let category = 'Other';
            const categoryKeywords = {
                'food': 'Food & Dining', 'groceries': 'Food & Dining', 'restaurant': 'Food & Dining',
                'transport': 'Transportation', 'uber': 'Transportation', 'taxi': 'Transportation',
                'shopping': 'Shopping', 'clothes': 'Shopping', 'entertainment': 'Entertainment',
                'movie': 'Entertainment', 'bills': 'Bills & Utilities', 'healthcare': 'Healthcare'
            };
            for (const [keyword, cat] of Object.entries(categoryKeywords)) {
                if (text.includes(keyword)) { category = cat; break; }
            }
            let description = transcript.replace(/add expense/gi, '').replace(/i spent/gi, '')
                .replace(/dollars?/gi, '').replace(/for/gi, '').trim();
            if (!description) description = category + ' expense';
            voiceData = { amount, category, description, date: new Date().toISOString().split('T')[0] };
            document.getElementById('voiceAmount').textContent = amount.toFixed(2);
            document.getElementById('voiceCategory').textContent = category;
            document.getElementById('voiceDescription').textContent = description;
            document.getElementById('voiceResult').style.display = 'flex';
        }

        async function confirmVoiceExpense() {
            if (!voiceData || voiceData.amount === 0) return;
            const response = await fetch('/api/expenses', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(voiceData)
            });
            if (response.ok) {
                document.getElementById('voiceResult').style.display = 'none';
                voiceData = null;
                await loadExpenses();
            }
        }

        function cancelVoiceExpense() {
            document.getElementById('voiceResult').style.display = 'none';
            voiceData = null;
        }

        async function loadExpenses() {
            const response = await fetch('/api/expenses');
            expenses = await response.json();
            updateDisplay();
        }

        async function saveExpense() {
            const amount = document.getElementById('amount').value;
            const category = document.getElementById('category').value;
            const description = document.getElementById('description').value;
            const date = document.getElementById('date').value;
            if (!amount || !description || !date) { alert('Fill all fields'); return; }
            const expense = { amount, category, description, date };
            if (isEditMode) {
                const expenseId = document.getElementById('editExpenseId').value;
                await fetch(`/api/expenses/${expenseId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(expense)
                });
            } else {
                await fetch('/api/expenses', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(expense)
                });
            }
            toggleAddForm();
            await loadExpenses();
        }

        async function deleteExpense(id) {
            if (confirm('Delete?')) {
                await fetch(`/api/expenses/${id}`, { method: 'DELETE' });
                await loadExpenses();
            }
        }

        function editExpense(id) {
            const expense = expenses.find(e => e.id === id);
            if (!expense) return;
            isEditMode = true;
            document.getElementById('expenseForm').style.display = 'flex';
            document.getElementById('addBtn').textContent = 'âœ• Close';
            document.getElementById('editExpenseId').value = expense.id;
            document.getElementById('amount').value = expense.amount;
            document.getElementById('category').value = expense.category;
            document.getElementById('description').value = expense.description;
            document.getElementById('date').value = expense.date;
            document.getElementById('saveBtn').textContent = 'Update';
        }

        function updateDisplay() {
            const selectedMonth = document.getElementById('monthSelector').value;
            const filtered = expenses.filter(e => e.date.startsWith(selectedMonth));
            const total = filtered.reduce((sum, e) => sum + parseFloat(e.amount), 0);
            loadMonthlyIncome();
            const income = parseFloat(document.getElementById('monthlyIncome').value) || 0;
            const saved = income - total;
            const savingsPercentage = income > 0 ? ((saved / income) * 100).toFixed(1) : 0;
            document.getElementById('totalSpending').textContent = `$${total.toFixed(2)}`;
            document.getElementById('totalTransactions').textContent = filtered.length;
            document.getElementById('savedAmount').textContent = `$${saved.toFixed(2)}`;
            document.getElementById('savingsPercentage').textContent = `${savingsPercentage}%`;
            document.getElementById('savedAmount').style.color = saved >= 0 ? '#22c55e' : '#ef4444';
            displayTransactions(filtered);
            updateCharts(filtered);
        }

        function displayTransactions(filtered) {
            const list = document.getElementById('transactionsList');
            if (filtered.length === 0) {
                list.innerHTML = '<div class="no-data">No expenses this month</div>';
                return;
            }
            list.innerHTML = filtered.sort((a, b) => new Date(b.date) - new Date(a.date))
                .map(e => `
                    <div class="trans-item">
                        <div class="trans-info">
                            <strong>$${parseFloat(e.amount).toFixed(2)}</strong>
                            <span>${e.description}</span>
                            <span class="trans-cat">${e.category}</span>
                            <span class="trans-date">${e.date}</span>
                        </div>
                        <div class="trans-btns">
                            <button onclick="editExpense(${e.id})" class="mini-btn">âœŽ</button>
                            <button onclick="deleteExpense(${e.id})" class="mini-btn">âœ•</button>
                        </div>
                    </div>
                `).join('');
        }

        function updateCharts(filtered) {
            const categories = {};
            filtered.forEach(e => {
                categories[e.category] = (categories[e.category] || 0) + parseFloat(e.amount);
            });
            const isDark = document.body.classList.contains('dark-mode');
            const textColor = isDark ? '#cccccc' : '#333';
            const gridColor = isDark ? '#222222' : '#e5e7eb';

            if (categoryChart) categoryChart.destroy();
            if (Object.keys(categories).length > 0) {
                const ctx1 = document.getElementById('categoryChart').getContext('2d');
                categoryChart = new Chart(ctx1, {
                    type: 'doughnut',
                    data: {
                        labels: Object.keys(categories),
                        datasets: [{
                            data: Object.values(categories),
                            backgroundColor: ['#0088FE', '#00C49F', '#FFBB28', '#FF8042', '#8884D8', '#82CA9D', '#FFC658', '#FF6B9D']
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: { legend: { position: 'bottom', labels: { color: textColor, font: { size: 10 } } } }
                    }
                });
            }

            const months = {};
            expenses.forEach(e => {
                const month = e.date.slice(0, 7);
                months[month] = (months[month] || 0) + parseFloat(e.amount);
            });
            const sortedMonths = Object.keys(months).sort().slice(-6);
            if (trendChart) trendChart.destroy();
            if (sortedMonths.length > 0) {
                const ctx2 = document.getElementById('trendChart').getContext('2d');
                trendChart = new Chart(ctx2, {
                    type: 'bar',
                    data: {
                        labels: sortedMonths,
                        datasets: [{ label: 'Spending', data: sortedMonths.map(m => months[m]), backgroundColor: '#8884D8' }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        scales: {
                            y: { beginAtZero: true, ticks: { color: textColor }, grid: { color: gridColor } },
                            x: { ticks: { color: textColor }, grid: { color: gridColor } }
                        },
                        plugins: { legend: { display: false } }
                    }
                });
            }
        }
    </script>
</body>
</html>