<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Expense Tracker</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div class="container">
        <header>
            <div class="flex items-center gap-3">
                <div style="font-size: 32px;">ðŸ’°</div>
                <h1>Expense Tracker</h1>
            </div>
            <div style="display: flex; gap: 10px; align-items: center;">
                <button id="darkModeToggle" onclick="toggleDarkMode()" class="btn-dark-mode" title="Toggle Dark Mode">
                    <span id="darkModeIcon">ðŸŒ™</span>
                </button>
                <button id="voiceBtn" onclick="startVoiceRecognition()" class="btn-voice">
                    ðŸŽ¤ Voice Add
                </button>
                <button onclick="showAddForm()" class="btn-primary">
                    + Add Expense
                </button>
            </div>
        </header>

        <!-- Voice Recognition Status -->
        <div id="voiceStatus" class="voice-status" style="display: none;">
            <div class="voice-indicator">
                <div class="pulse">ðŸŽ¤</div>
                <p id="voiceText">Listening... Speak now!</p>
            </div>
            <p class="voice-hint">Try: "Add 50 dollars for groceries" or "I spent 20 on food"</p>
            <button onclick="stopVoiceRecognition()" class="btn-secondary">Stop Listening</button>
        </div>

        <!-- Voice Result Preview -->
        <div id="voiceResult" class="voice-result" style="display: none;">
            <h3>âœ“ Voice Command Recognized</h3>
            <div class="voice-parsed">
                <p><strong>Amount:</strong> $<span id="voiceAmount">0</span></p>
                <p><strong>Category:</strong> <span id="voiceCategory">-</span></p>
                <p><strong>Description:</strong> <span id="voiceDescription">-</span></p>
            </div>
            <div class="voice-actions">
                <button onclick="confirmVoiceExpense()" class="btn-primary">âœ“ Confirm & Save</button>
                <button onclick="cancelVoiceExpense()" class="btn-secondary">âœ— Cancel</button>
                <button onclick="startVoiceRecognition()" class="btn-voice">ðŸŽ¤ Try Again</button>
            </div>
        </div>

        <!-- Add Expense Form -->
        <div id="expenseForm" class="form-container" style="display: none;">
            <h2 id="formTitle">New Expense</h2>
            <input type="hidden" id="editExpenseId">
            <div class="form-grid">
                <div class="form-group">
                    <label>Amount ($)</label>
                    <input type="number" id="amount" step="0.01" placeholder="0.00">
                </div>
                <div class="form-group">
                    <label>Category</label>
                    <select id="category">
                        <option>Food & Dining</option>
                        <option>Transportation</option>
                        <option>Shopping</option>
                        <option>Entertainment</option>
                        <option>Bills & Utilities</option>
                        <option>Healthcare</option>
                        <option>Education</option>
                        <option>Other</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Description</label>
                    <input type="text" id="description" placeholder="What did you spend on?">
                </div>
                <div class="form-group">
                    <label>Date</label>
                    <input type="date" id="date">
                </div>
            </div>
            <div class="form-actions">
                <button onclick="saveExpense()" class="btn-primary" id="saveBtn">Add Expense</button>
                <button onclick="cancelForm()" class="btn-secondary">Cancel</button>
            </div>
        </div>

        <!-- Summary Cards -->
        <div class="summary-cards">
            <div class="card">
                <h3>Total Spending</h3>
                <p class="amount" id="totalSpending">$0.00</p>
                <small>This month</small>
            </div>
            <div class="card">
                <h3>Transactions</h3>
                <p class="amount" id="totalTransactions">0</p>
                <small>This month</small>
            </div>
            <div class="card">
                <h3>Select Month</h3>
                <input type="month" id="monthSelector" class="month-input">
            </div>
        </div>

        <!-- Charts -->
        <div class="charts-container">
            <div class="chart-card">
                <h3>Spending by Category</h3>
                <canvas id="categoryChart"></canvas>
            </div>
            <div class="chart-card">
                <h3>Monthly Trend</h3>
                <canvas id="trendChart"></canvas>
            </div>
        </div>

        <!-- Transactions List -->
        <div class="transactions-container">
            <h3>Recent Transactions</h3>
            <div id="transactionsList"></div>
        </div>
    </div>

    <script>
        let expenses = [];
        let categoryChart = null;
        let trendChart = null;
        let isEditMode = false;
        let recognition = null;
        let voiceData = null;

        document.addEventListener('DOMContentLoaded', function() {
            const today = new Date();
            document.getElementById('date').valueAsDate = today;
            document.getElementById('monthSelector').value = today.toISOString().slice(0, 7);
            document.getElementById('monthSelector').addEventListener('change', updateDisplay);

            // Load dark mode preference
            loadDarkModePreference();

            initVoiceRecognition();
            loadExpenses();
        });

        // Dark Mode Functions
        function toggleDarkMode() {
            document.body.classList.toggle('dark-mode');
            const isDark = document.body.classList.contains('dark-mode');
            document.getElementById('darkModeIcon').textContent = isDark ? 'â˜€ï¸' : 'ðŸŒ™';
            localStorage.setItem('darkMode', isDark ? 'enabled' : 'disabled');

            // Update charts for dark mode
            updateDisplay();
        }

        function loadDarkModePreference() {
            const darkMode = localStorage.getItem('darkMode');
            if (darkMode === 'enabled') {
                document.body.classList.add('dark-mode');
                document.getElementById('darkModeIcon').textContent = 'â˜€ï¸';
            }
        }

        function initVoiceRecognition() {
            if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                recognition = new SpeechRecognition();
                recognition.continuous = false;
                recognition.interimResults = false;
                recognition.lang = 'en-US';

                recognition.onresult = function(event) {
                    const transcript = event.results[0][0].transcript;
                    parseVoiceCommand(transcript);
                };

                recognition.onerror = function(event) {
                    document.getElementById('voiceStatus').style.display = 'none';
                    alert('Voice recognition error: ' + event.error + '. Please try again.');
                };

                recognition.onend = function() {
                    document.getElementById('voiceStatus').style.display = 'none';
                };
            } else {
                document.getElementById('voiceBtn').disabled = true;
                document.getElementById('voiceBtn').title = 'Voice recognition not supported';
            }
        }

        function startVoiceRecognition() {
            if (!recognition) {
                alert('Voice recognition not supported in your browser. Use Chrome, Edge, or Safari.');
                return;
            }
            document.getElementById('voiceStatus').style.display = 'block';
            document.getElementById('voiceResult').style.display = 'none';
            document.getElementById('expenseForm').style.display = 'none';
            try {
                recognition.start();
            } catch (e) {
                console.error('Recognition error:', e);
            }
        }

        function stopVoiceRecognition() {
            if (recognition) recognition.stop();
            document.getElementById('voiceStatus').style.display = 'none';
        }

        function parseVoiceCommand(transcript) {
            const text = transcript.toLowerCase();
            const amountMatch = text.match(/(\d+(?:\.\d{1,2})?)/);
            const amount = amountMatch ? parseFloat(amountMatch[1]) : 0;

            let category = 'Other';
            const categoryKeywords = {
                'food': 'Food & Dining', 'dining': 'Food & Dining', 'groceries': 'Food & Dining',
                'restaurant': 'Food & Dining', 'lunch': 'Food & Dining', 'dinner': 'Food & Dining',
                'breakfast': 'Food & Dining', 'coffee': 'Food & Dining',
                'transport': 'Transportation', 'transportation': 'Transportation', 'uber': 'Transportation',
                'taxi': 'Transportation', 'gas': 'Transportation', 'fuel': 'Transportation',
                'bus': 'Transportation', 'train': 'Transportation',
                'shopping': 'Shopping', 'clothes': 'Shopping', 'shop': 'Shopping',
                'entertainment': 'Entertainment', 'movie': 'Entertainment', 'game': 'Entertainment',
                'bills': 'Bills & Utilities', 'utilities': 'Bills & Utilities', 'electricity': 'Bills & Utilities',
                'water': 'Bills & Utilities', 'internet': 'Bills & Utilities', 'phone': 'Bills & Utilities',
                'healthcare': 'Healthcare', 'medical': 'Healthcare', 'doctor': 'Healthcare',
                'medicine': 'Healthcare', 'pharmacy': 'Healthcare',
                'education': 'Education', 'school': 'Education', 'course': 'Education', 'book': 'Education'
            };

            for (const [keyword, cat] of Object.entries(categoryKeywords)) {
                if (text.includes(keyword)) {
                    category = cat;
                    break;
                }
            }

            let description = transcript
                .replace(/add expense/gi, '')
                .replace(/i spent/gi, '')
                .replace(/dollars?/gi, '')
                .replace(/for/gi, '')
                .trim();

            if (!description) description = category + ' expense';

            voiceData = {
                amount: amount,
                category: category,
                description: description,
                date: new Date().toISOString().split('T')[0]
            };

            document.getElementById('voiceAmount').textContent = amount.toFixed(2);
            document.getElementById('voiceCategory').textContent = category;
            document.getElementById('voiceDescription').textContent = description;
            document.getElementById('voiceResult').style.display = 'block';
        }

        async function confirmVoiceExpense() {
            if (!voiceData || voiceData.amount === 0) {
                alert('Could not detect amount. Please try again.');
                return;
            }

            const response = await fetch('/api/expenses', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(voiceData)
            });

            if (response.ok) {
                document.getElementById('voiceResult').style.display = 'none';
                voiceData = null;
                await loadExpenses();
            }
        }

        function cancelVoiceExpense() {
            document.getElementById('voiceResult').style.display = 'none';
            voiceData = null;
        }

        function showAddForm() {
            isEditMode = false;
            document.getElementById('formTitle').textContent = 'New Expense';
            document.getElementById('saveBtn').textContent = 'Add Expense';
            document.getElementById('editExpenseId').value = '';
            document.getElementById('amount').value = '';
            document.getElementById('category').value = 'Food & Dining';
            document.getElementById('description').value = '';
            document.getElementById('date').valueAsDate = new Date();
            document.getElementById('expenseForm').style.display = 'block';
            document.getElementById('voiceResult').style.display = 'none';
        }

        function showEditForm(expense) {
            isEditMode = true;
            document.getElementById('formTitle').textContent = 'Edit Expense';
            document.getElementById('saveBtn').textContent = 'Update Expense';
            document.getElementById('editExpenseId').value = expense.id;
            document.getElementById('amount').value = expense.amount;
            document.getElementById('category').value = expense.category;
            document.getElementById('description').value = expense.description;
            document.getElementById('date').value = expense.date;
            document.getElementById('expenseForm').style.display = 'block';
            document.getElementById('voiceResult').style.display = 'none';
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function cancelForm() {
            document.getElementById('expenseForm').style.display = 'none';
            isEditMode = false;
        }

        async function loadExpenses() {
            const response = await fetch('/api/expenses');
            expenses = await response.json();
            updateDisplay();
        }

        async function saveExpense() {
            const amount = document.getElementById('amount').value;
            const category = document.getElementById('category').value;
            const description = document.getElementById('description').value;
            const date = document.getElementById('date').value;

            if (!amount || !description || !date) {
                alert('Please fill in all fields');
                return;
            }

            const expense = { amount, category, description, date };

            if (isEditMode) {
                const expenseId = document.getElementById('editExpenseId').value;
                await fetch(`/api/expenses/${expenseId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(expense)
                });
            } else {
                await fetch('/api/expenses', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(expense)
                });
            }
            cancelForm();
            await loadExpenses();
        }

        async function deleteExpense(id) {
            if (confirm('Are you sure you want to delete this expense?')) {
                await fetch(`/api/expenses/${id}`, { method: 'DELETE' });
                await loadExpenses();
            }
        }

        function editExpense(id) {
            const expense = expenses.find(e => e.id === id);
            if (expense) showEditForm(expense);
        }

        function updateDisplay() {
            const selectedMonth = document.getElementById('monthSelector').value;
            const filtered = expenses.filter(e => e.date.startsWith(selectedMonth));
            const total = filtered.reduce((sum, e) => sum + parseFloat(e.amount), 0);

            document.getElementById('totalSpending').textContent = `$${total.toFixed(2)}`;
            document.getElementById('totalTransactions').textContent = filtered.length;
            displayTransactions(filtered);
            updateCharts(filtered);
        }

        function displayTransactions(filtered) {
            const list = document.getElementById('transactionsList');
            if (filtered.length === 0) {
                list.innerHTML = '<p class="no-data">No expenses for this month. Start tracking!</p>';
                return;
            }
            list.innerHTML = filtered.sort((a, b) => new Date(b.date) - new Date(a.date))
                .map(e => `
                    <div class="transaction-item">
                        <div class="transaction-info">
                            <div>
                                <strong>${e.description}</strong>
                                <span class="category-badge">${e.category}</span>
                            </div>
                            <small>${e.date}</small>
                        </div>
                        <div class="transaction-actions">
                            <strong>$${parseFloat(e.amount).toFixed(2)}</strong>
                            <button onclick="editExpense(${e.id})" class="btn-edit">Edit</button>
                            <button onclick="deleteExpense(${e.id})" class="btn-delete">Delete</button>
                        </div>
                    </div>
                `).join('');
        }

        function updateCharts(filtered) {
            const categories = {};
            filtered.forEach(e => {
                categories[e.category] = (categories[e.category] || 0) + parseFloat(e.amount);
            });

            const isDark = document.body.classList.contains('dark-mode');
            const textColor = isDark ? '#cccccc' : '#333';
            const gridColor = isDark ? '#222222' : '#e5e7eb';

            if (categoryChart) categoryChart.destroy();
            if (Object.keys(categories).length > 0) {
                const ctx1 = document.getElementById('categoryChart').getContext('2d');
                categoryChart = new Chart(ctx1, {
                    type: 'doughnut',
                    data: {
                        labels: Object.keys(categories),
                        datasets: [{
                            data: Object.values(categories),
                            backgroundColor: ['#0088FE', '#00C49F', '#FFBB28', '#FF8042', '#8884D8', '#82CA9D', '#FFC658', '#FF6B9D']
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: { color: textColor }
                            }
                        }
                    }
                });
            }

            const months = {};
            expenses.forEach(e => {
                const month = e.date.slice(0, 7);
                months[month] = (months[month] || 0) + parseFloat(e.amount);
            });

            const sortedMonths = Object.keys(months).sort().slice(-6);
            if (trendChart) trendChart.destroy();
            if (sortedMonths.length > 0) {
                const ctx2 = document.getElementById('trendChart').getContext('2d');
                trendChart = new Chart(ctx2, {
                    type: 'bar',
                    data: {
                        labels: sortedMonths,
                        datasets: [{
                            label: 'Monthly Spending',
                            data: sortedMonths.map(m => months[m]),
                            backgroundColor: '#8884D8'
                        }]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: { color: textColor },
                                grid: { color: gridColor }
                            },
                            x: {
                                ticks: { color: textColor },
                                grid: { color: gridColor }
                            }
                        },
                        plugins: {
                            legend: {
                                labels: { color: textColor }
                            }
                        }
                    }
                });
            }
        }
    </script>
</body>
</html>