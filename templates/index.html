<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Personal Expense Tracker</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div class="compact-container">
        <!-- Top Header Row -->
        <header class="top-header">
            <h1>ðŸ’° Expense Tracker</h1>
            <div class="top-actions">
                <select id="displayCurrency" class="currency-selector" onchange="updateDisplay()">
                    <option value="USD">USD $</option>
                    <option value="EUR">EUR â‚¬</option>
                    <option value="GBP">GBP Â£</option>
                    <option value="JPY">JPY Â¥</option>
                    <option value="CNY">CNY Â¥</option>
                    <option value="INR">INR â‚¹</option>
                    <option value="KRW">KRW â‚©</option>
                    <option value="BDT">BDT à§³</option>
                    <option value="AUD">AUD $</option>
                    <option value="CAD">CAD $</option>
                    <option value="CHF">CHF Fr</option>
                </select>
                <button id="darkModeToggle" onclick="toggleDarkMode()" class="icon-btn-top">
                    <span id="darkModeIcon">ðŸŒ™</span>
                </button>
                <button id="voiceBtn" onclick="startVoiceRecognition()" class="action-btn-top">
                    ðŸŽ¤ Voice Add
                </button>
                <button onclick="toggleAddForm()" class="action-btn-top" id="addBtn">
                    + Add Expense
                </button>
                <button onclick="showUserMenu()" class="icon-btn-top" id="userMenuBtn">ðŸ‘¤</button>
                <div id="userMenu" class="user-menu" style="display: none;">
                    <div class="user-menu-header">
                        <strong id="userName">User</strong>
                        <div id="userEmail" style="font-size: 11px; color: #888;"></div>
                    </div>
                    <button onclick="handleLogout()" class="user-menu-item">ðŸšª Logout</button>
                </div>
            </div>
        </header>

        <div class="note-text">Exchange rates updated: <span id="ratesUpdate">Loading...</span></div>

        <!-- Voice Status (Compact) -->
        <div id="voiceStatus" class="voice-inline" style="display: none;">
            <span class="pulse-icon">ðŸŽ¤</span>
            <span>Listening...</span>
            <button onclick="stopVoiceRecognition()" class="close-btn">âœ•</button>
        </div>

        <!-- Voice Result -->
        <div id="voiceResult" class="voice-inline" style="display: none;">
            <span><strong><span id="voiceCurrencySymbol">$</span><span id="voiceAmount">0</span></strong> â€¢ <span id="voiceCategory">-</span> â€¢ <span id="voiceDescription">-</span></span>
            <div>
                <button onclick="confirmVoiceExpense()" class="mini-btn success">âœ“</button>
                <button onclick="cancelVoiceExpense()" class="mini-btn cancel">âœ•</button>
            </div>
        </div>

        <!-- Inline Add Form -->
        <div id="expenseForm" class="add-form-inline" style="display: none;">
            <input type="hidden" id="editExpenseId">
            <input type="number" id="amount" step="0.01" placeholder="Amount" class="input-compact">
            <select id="expenseCurrency" class="input-compact">
                <option value="USD">USD $</option>
                <option value="EUR">EUR â‚¬</option>
                <option value="GBP">GBP Â£</option>
                <option value="JPY">JPY Â¥</option>
                <option value="CNY">CNY Â¥</option>
                <option value="INR">INR â‚¹</option>
                <option value="KRW">KRW â‚©</option>
                <option value="BDT">BDT à§³</option>
                <option value="AUD">AUD $</option>
                <option value="CAD">CAD $</option>
                <option value="CHF">CHF Fr</option>
            </select>
            <select id="category" class="input-compact">
                <option>Food & Dining</option>
                <option>Transportation</option>
                <option>Shopping</option>
                <option>Entertainment</option>
                <option>Bills & Utilities</option>
                <option>Healthcare</option>
                <option>Education</option>
                <option>Other</option>
            </select>
            <input type="text" id="description" placeholder="Description" class="input-compact">
            <input type="date" id="date" class="input-compact">
            <button onclick="saveExpense()" class="mini-btn success" id="saveBtn">Save</button>
            <button onclick="toggleAddForm()" class="mini-btn cancel">Cancel</button>
        </div>

        <!-- Stats Row -->
        <div class="stats-row">
            <div class="stat-box">
                <select id="monthSelector" class="month-select"></select>
            </div>
            <div class="stat-box">
                <div class="stat-label">Income</div>
                <input type="number" id="monthlyIncome" step="0.01" placeholder="0" class="stat-input">
            </div>
            <div class="stat-box">
                <div class="stat-label">Total Spending</div>
                <div class="stat-value" id="totalSpending">$0.00</div>
            </div>
            <div class="stat-box">
                <div class="stat-label">Transactions</div>
                <div class="stat-value" id="totalTransactions">0</div>
            </div>
            <div class="stat-box highlight">
                <div class="stat-label">Saved</div>
                <div class="stat-value" id="savedAmount">$0.00</div>
                <div class="stat-percentage" id="savingsPercentage">0%</div>
            </div>
        </div>

        <!-- Main Content Grid -->
        <div class="content-grid">
            <!-- Recent Transactions -->
            <div class="transactions-box">
                <h3>Recent Transactions</h3>
                <div id="transactionsList" class="transactions-scroll"></div>
            </div>

            <!-- Charts Row -->
            <div class="chart-box">
                <h3>Spending by Category</h3>
                <canvas id="categoryChart"></canvas>
            </div>
            <div class="chart-box">
                <h3>Monthly Trend</h3>
                <canvas id="trendChart"></canvas>
            </div>
        </div>
    </div>

    <script>
        let expenses = [];
        let categoryChart = null;
        let trendChart = null;
        let isEditMode = false;
        let recognition = null;
        let voiceData = null;
        let exchangeRates = { base: 'USD', rates: { USD: 1 } };

        const currencySymbols = {
            'USD': '$', 'EUR': 'â‚¬', 'GBP': 'Â£', 'JPY': 'Â¥', 'CNY': 'Â¥',
            'INR': 'â‚¹', 'KRW': 'â‚©', 'BDT': 'à§³', 'AUD': 'A$', 'CAD': 'C$', 'CHF': 'Fr'
        };

        document.addEventListener('DOMContentLoaded', function() {
            const today = new Date();
            document.getElementById('date').valueAsDate = today;
            generateMonthOptions();
            loadUserInfo();
            loadExchangeRates();
            document.getElementById('monthSelector').addEventListener('change', updateDisplay);
            document.getElementById('monthlyIncome').addEventListener('change', saveMonthlyIncome);
            document.getElementById('monthlyIncome').addEventListener('blur', saveMonthlyIncome);
            loadDarkModePreference();
            loadCurrencyPreference();
            initVoiceRecognition();
            loadExpenses();
        });

        async function loadUserInfo() {
            try {
                const response = await fetch('/api/user');
                if (response.ok) {
                    const user = await response.json();
                    document.getElementById('userName').textContent = user.name;
                    document.getElementById('userEmail').textContent = user.email;
                } else {
                    window.location.href = '/login';
                }
            } catch (error) {
                console.error('Failed to load user info:', error);
                window.location.href = '/login';
            }
        }

        function showUserMenu() {
            const menu = document.getElementById('userMenu');
            menu.style.display = menu.style.display === 'none' ? 'block' : 'none';
        }

        async function handleLogout() {
            try {
                const response = await fetch('/api/logout', { method: 'POST' });
                if (response.ok) {
                    window.location.href = '/login';
                }
            } catch (error) {
                console.error('Logout failed:', error);
                alert('Logout failed. Please try again.');
            }
        }

        document.addEventListener('click', function(event) {
            const menu = document.getElementById('userMenu');
            const btn = document.getElementById('userMenuBtn');
            if (menu && btn && !menu.contains(event.target) && !btn.contains(event.target)) {
                menu.style.display = 'none';
            }
        });

        async function loadExchangeRates() {
            try {
                const response = await fetch('/api/exchange-rates');
                exchangeRates = await response.json();
                const date = new Date(exchangeRates.last_update);
                document.getElementById('ratesUpdate').textContent = date.toLocaleDateString();
            } catch (error) {
                console.error('Failed to load exchange rates:', error);
                document.getElementById('ratesUpdate').textContent = 'Unavailable';
            }
        }

        function convertCurrency(amount, fromCurrency, toCurrency) {
            if (fromCurrency === toCurrency) return amount;
            const amountInBase = amount / exchangeRates.rates[fromCurrency];
            return amountInBase * exchangeRates.rates[toCurrency];
        }

        function formatCurrency(amount, currency) {
            const symbol = currencySymbols[currency] || currency;
            const decimals = (currency === 'JPY' || currency === 'KRW') ? 0 : 2;
            return `${symbol}${amount.toFixed(decimals)}`;
        }

        function loadCurrencyPreference() {
            const savedCurrency = localStorage.getItem('displayCurrency');
            if (savedCurrency) {
                document.getElementById('displayCurrency').value = savedCurrency;
            }
        }

        function saveCurrencyPreference() {
            const currency = document.getElementById('displayCurrency').value;
            localStorage.setItem('displayCurrency', currency);
        }

        function generateMonthOptions() {
            const selector = document.getElementById('monthSelector');
            const today = new Date();
            const currentYear = today.getFullYear();
            const currentMonth = today.getMonth();
            const months = [];
            for (let i = -12; i <= 12; i++) {
                const date = new Date(currentYear, currentMonth + i, 1);
                const yearMonth = date.toISOString().slice(0, 7);
                const monthName = date.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
                months.push({ value: yearMonth, label: monthName });
            }
            selector.innerHTML = months.map(m =>
                `<option value="${m.value}" ${m.value === today.toISOString().slice(0, 7) ? 'selected' : ''}>${m.label}</option>`
            ).join('');
        }

        function toggleDarkMode() {
            document.body.classList.toggle('dark-mode');
            const isDark = document.body.classList.contains('dark-mode');
            document.getElementById('darkModeIcon').textContent = isDark ? 'â˜€ï¸' : 'ðŸŒ™';
            localStorage.setItem('darkMode', isDark ? 'enabled' : 'disabled');
            updateDisplay();
        }

        function loadDarkModePreference() {
            const darkMode = localStorage.getItem('darkMode');
            if (darkMode === 'enabled') {
                document.body.classList.add('dark-mode');
                document.getElementById('darkModeIcon').textContent = 'â˜€ï¸';
            }
        }

        function toggleAddForm() {
            const form = document.getElementById('expenseForm');
            const isVisible = form.style.display !== 'none';
            form.style.display = isVisible ? 'none' : 'flex';
            document.getElementById('addBtn').textContent = isVisible ? '+ Add Expense' : 'âœ• Close';
            if (!isVisible) {
                isEditMode = false;
                document.getElementById('editExpenseId').value = '';
                document.getElementById('amount').value = '';
                document.getElementById('expenseCurrency').value = document.getElementById('displayCurrency').value;
                document.getElementById('category').value = 'Food & Dining';
                document.getElementById('description').value = '';
                document.getElementById('date').valueAsDate = new Date();
                document.getElementById('saveBtn').textContent = 'Save';
            }
        }

        function loadMonthlyIncome() {
            const selectedMonth = document.getElementById('monthSelector').value;
            const displayCurrency = document.getElementById('displayCurrency').value;
            const incomeKey = `income_${selectedMonth}_${displayCurrency}`;
            const savedIncome = localStorage.getItem(incomeKey);
            document.getElementById('monthlyIncome').value = savedIncome || '';
        }

        function saveMonthlyIncome() {
            const selectedMonth = document.getElementById('monthSelector').value;
            const displayCurrency = document.getElementById('displayCurrency').value;
            const income = document.getElementById('monthlyIncome').value;
            const incomeKey = `income_${selectedMonth}_${displayCurrency}`;
            if (income) {
                localStorage.setItem(incomeKey, income);
            } else {
                localStorage.removeItem(incomeKey);
            }
            updateDisplay();
        }

        function initVoiceRecognition() {
            if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                recognition = new SpeechRecognition();
                recognition.continuous = false;
                recognition.interimResults = false;
                recognition.lang = 'en-US';
                recognition.onresult = function(event) {
                    parseVoiceCommand(event.results[0][0].transcript);
                };
                recognition.onerror = function(event) {
                    document.getElementById('voiceStatus').style.display = 'none';
                };
                recognition.onend = function() {
                    document.getElementById('voiceStatus').style.display = 'none';
                };
            } else {
                document.getElementById('voiceBtn').disabled = true;
            }
        }

        function startVoiceRecognition() {
            if (!recognition) return;
            document.getElementById('voiceStatus').style.display = 'flex';
            document.getElementById('voiceResult').style.display = 'none';
            document.getElementById('expenseForm').style.display = 'none';
            document.getElementById('addBtn').textContent = '+ Add Expense';
            try { recognition.start(); } catch (e) {}
        }

        function stopVoiceRecognition() {
            if (recognition) recognition.stop();
            document.getElementById('voiceStatus').style.display = 'none';
        }

        function parseVoiceCommand(transcript) {
            const text = transcript.toLowerCase();
            const amountMatch = text.match(/(\d+(?:\.\d{1,2})?)/);
            const amount = amountMatch ? parseFloat(amountMatch[1]) : 0;

            let currency = document.getElementById('displayCurrency').value;
            const currencyKeywords = {
                'dollar': 'USD', 'usd': 'USD',
                'euro': 'EUR', 'eur': 'EUR',
                'pound': 'GBP', 'gbp': 'GBP',
                'yen': 'JPY', 'jpy': 'JPY',
                'yuan': 'CNY', 'cny': 'CNY',
                'rupee': 'INR', 'inr': 'INR',
                'won': 'KRW', 'krw': 'KRW',
                'taka': 'BDT', 'bdt': 'BDT', 'bangladeshi': 'BDT'
            };
            for (const [keyword, curr] of Object.entries(currencyKeywords)) {
                if (text.includes(keyword)) { currency = curr; break; }
            }

            let category = 'Other';
            const categoryKeywords = {
                'food': 'Food & Dining', 'groceries': 'Food & Dining', 'restaurant': 'Food & Dining',
                'transport': 'Transportation', 'uber': 'Transportation', 'taxi': 'Transportation',
                'shopping': 'Shopping', 'clothes': 'Shopping', 'entertainment': 'Entertainment',
                'movie': 'Entertainment', 'bills': 'Bills & Utilities', 'healthcare': 'Healthcare'
            };
            for (const [keyword, cat] of Object.entries(categoryKeywords)) {
                if (text.includes(keyword)) { category = cat; break; }
            }

            let description = transcript.replace(/add expense/gi, '').replace(/i spent/gi, '')
                .replace(/dollars?/gi, '').replace(/euros?/gi, '').replace(/pounds?/gi, '')
                .replace(/taka/gi, '').replace(/for/gi, '').trim();
            if (!description) description = category + ' expense';

            voiceData = {
                amount,
                currency,
                category,
                description,
                date: new Date().toISOString().split('T')[0]
            };

            document.getElementById('voiceCurrencySymbol').textContent = currencySymbols[currency];
            document.getElementById('voiceAmount').textContent = amount.toFixed(2);
            document.getElementById('voiceCategory').textContent = category;
            document.getElementById('voiceDescription').textContent = description;
            document.getElementById('voiceResult').style.display = 'flex';
        }

        async function confirmVoiceExpense() {
            if (!voiceData || voiceData.amount === 0) return;
            const response = await fetch('/api/expenses', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(voiceData)
            });
            if (response.ok) {
                document.getElementById('voiceResult').style.display = 'none';
                voiceData = null;
                await loadExpenses();
            }
        }

        function cancelVoiceExpense() {
            document.getElementById('voiceResult').style.display = 'none';
            voiceData = null;
        }

        async function loadExpenses() {
            try {
                const response = await fetch('/api/expenses');
                if (response.ok) {
                    expenses = await response.json();
                    expenses = expenses.map(e => ({
                        ...e,
                        currency: e.currency || 'USD'
                    }));
                    updateDisplay();
                } else {
                    console.error('Failed to load expenses');
                }
            } catch (error) {
                console.error('Error loading expenses:', error);
            }
        }

        async function saveExpense() {
            const amount = document.getElementById('amount').value;
            const currency = document.getElementById('expenseCurrency').value;
            const category = document.getElementById('category').value;
            const description = document.getElementById('description').value;
            const date = document.getElementById('date').value;
            if (!amount || !description || !date) {
                alert('Please fill all fields');
                return;
            }
            const expense = { amount, currency, category, description, date };
            try {
                if (isEditMode) {
                    const expenseId = document.getElementById('editExpenseId').value;
                    await fetch(`/api/expenses/${expenseId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(expense)
                    });
                } else {
                    await fetch('/api/expenses', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(expense)
                    });
                }
                toggleAddForm();
                await loadExpenses();
            } catch (error) {
                console.error('Error saving expense:', error);
                alert('Failed to save expense. Please try again.');
            }
        }

        async function deleteExpense(id) {
            if (confirm('Delete this expense?')) {
                try {
                    await fetch(`/api/expenses/${id}`, { method: 'DELETE' });
                    await loadExpenses();
                } catch (error) {
                    console.error('Error deleting expense:', error);
                    alert('Failed to delete expense. Please try again.');
                }
            }
        }

        function editExpense(id) {
            const expense = expenses.find(e => e.id === id);
            if (!expense) return;
            isEditMode = true;
            document.getElementById('expenseForm').style.display = 'flex';
            document.getElementById('addBtn').textContent = 'âœ• Close';
            document.getElementById('editExpenseId').value = expense.id;
            document.getElementById('amount').value = expense.amount;
            document.getElementById('expenseCurrency').value = expense.currency || 'USD';
            document.getElementById('category').value = expense.category;
            document.getElementById('description').value = expense.description;
            document.getElementById('date').value = expense.date;
            document.getElementById('saveBtn').textContent = 'Update';
        }

        function updateDisplay() {
            saveCurrencyPreference();
            const selectedMonth = document.getElementById('monthSelector').value;
            const displayCurrency = document.getElementById('displayCurrency').value;
            const filtered = expenses.filter(e => e.date.startsWith(selectedMonth));

            const total = filtered.reduce((sum, e) => {
                const convertedAmount = convertCurrency(
                    parseFloat(e.amount),
                    e.currency || 'USD',
                    displayCurrency
                );
                return sum + convertedAmount;
            }, 0);

            loadMonthlyIncome();
            const income = parseFloat(document.getElementById('monthlyIncome').value) || 0;
            const saved = income - total;
            const savingsPercentage = income > 0 ? ((saved / income) * 100).toFixed(1) : 0;

            document.getElementById('totalSpending').textContent = formatCurrency(total, displayCurrency);
            document.getElementById('totalTransactions').textContent = filtered.length;
            document.getElementById('savedAmount').textContent = formatCurrency(saved, displayCurrency);
            document.getElementById('savingsPercentage').textContent = `${savingsPercentage}%`;
            document.getElementById('savedAmount').style.color = saved >= 0 ? '#22c55e' : '#ef4444';

            displayTransactions(filtered, displayCurrency);
            updateCharts(filtered, displayCurrency);
        }

        function displayTransactions(filtered, displayCurrency) {
            const list = document.getElementById('transactionsList');
            if (filtered.length === 0) {
                list.innerHTML = '<div class="no-data">No expenses this month</div>';
                return;
            }
            list.innerHTML = filtered.sort((a, b) => new Date(b.date) - new Date(a.date))
                .map(e => {
                    const originalCurrency = e.currency || 'USD';
                    const originalAmount = parseFloat(e.amount);
                    const convertedAmount = convertCurrency(originalAmount, originalCurrency, displayCurrency);
                    const showConversion = originalCurrency !== displayCurrency;

                    return `
                        <div class="trans-item">
                            <div class="trans-info">
                                <strong>${formatCurrency(convertedAmount, displayCurrency)}</strong>
                                <span>${e.description}</span>
                                <span class="trans-cat">${e.category}</span>
                                <span class="trans-date">${e.date}${showConversion ? ' â€¢ ' + formatCurrency(originalAmount, originalCurrency) : ''}</span>
                            </div>
                            <div class="trans-btns">
                                <button onclick="editExpense(${e.id})" class="mini-btn">âœŽ</button>
                                <button onclick="deleteExpense(${e.id})" class="mini-btn">âœ•</button>
                            </div>
                        </div>
                    `;
                }).join('');
        }

        function updateCharts(filtered, displayCurrency) {
            const categories = {};
            filtered.forEach(e => {
                const convertedAmount = convertCurrency(
                    parseFloat(e.amount),
                    e.currency || 'USD',
                    displayCurrency
                );
                categories[e.category] = (categories[e.category] || 0) + convertedAmount;
            });

            const isDark = document.body.classList.contains('dark-mode');
            const textColor = isDark ? '#cccccc' : '#333';
            const gridColor = isDark ? '#222222' : '#e5e7eb';

            if (categoryChart) categoryChart.destroy();
            if (Object.keys(categories).length > 0) {
                const ctx1 = document.getElementById('categoryChart').getContext('2d');
                categoryChart = new Chart(ctx1, {
                    type: 'doughnut',
                    data: {
                        labels: Object.keys(categories),
                        datasets: [{
                            data: Object.values(categories),
                            backgroundColor: ['#0088FE', '#00C49F', '#FFBB28', '#FF8042', '#8884D8', '#82CA9D', '#FFC658', '#FF6B9D']
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: { legend: { position: 'bottom', labels: { color: textColor, font: { size: 10 } } } }
                    }
                });
            }

            const months = {};
            expenses.forEach(e => {
                const month = e.date.slice(0, 7);
                const convertedAmount = convertCurrency(
                    parseFloat(e.amount),
                    e.currency || 'USD',
                    displayCurrency
                );
                months[month] = (months[month] || 0) + convertedAmount;
            });
            const sortedMonths = Object.keys(months).sort().slice(-6);
            if (trendChart) trendChart.destroy();
            if (sortedMonths.length > 0) {
                const ctx2 = document.getElementById('trendChart').getContext('2d');
                trendChart = new Chart(ctx2, {
                    type: 'bar',
                    data: {
                        labels: sortedMonths,
                        datasets: [{
                            label: `Spending (${displayCurrency})`,
                            data: sortedMonths.map(m => months[m]),
                            backgroundColor: '#8884D8'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        scales: {
                            y: { beginAtZero: true, ticks: { color: textColor }, grid: { color: gridColor } },
                            x: { ticks: { color: textColor }, grid: { color: gridColor } }
                        },
                        plugins: { legend: { display: false } }
                    }
                });
            }
        }
    </script>
</body>
</html>