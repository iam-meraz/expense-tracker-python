<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Expense Tracker</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div class="container">
        <header>
            <h1>ðŸ’° Expense Tracker</h1>
            <button id="addBtn" class="btn-primary">+ Add Expense</button>
        </header>

        <!-- Add Expense Form -->
        <div id="expenseForm" class="form-container" style="display: none;">
            <h2 id="formTitle">New Expense</h2>
            <input type="hidden" id="editExpenseId">
            <div class="form-grid">
                <div class="form-group">
                    <label>Amount ($)</label>
                    <input type="number" id="amount" step="0.01" placeholder="0.00" required>
                </div>
                <div class="form-group">
                    <label>Category</label>
                    <select id="category">
                        <option>Food & Dining</option>
                        <option>Transportation</option>
                        <option>Shopping</option>
                        <option>Entertainment</option>
                        <option>Bills & Utilities</option>
                        <option>Healthcare</option>
                        <option>Education</option>
                        <option>Other</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Description</label>
                    <input type="text" id="description" placeholder="What did you spend on?" required>
                </div>
                <div class="form-group">
                    <label>Date</label>
                    <input type="date" id="date" required>
                </div>
            </div>
            <div class="form-actions">
                <button onclick="saveExpense()" class="btn-primary" id="saveBtn">Add Expense</button>
                <button onclick="cancelForm()" class="btn-secondary">Cancel</button>
            </div>
        </div>

        <!-- Summary Cards -->
        <div class="summary-cards">
            <div class="card">
                <h3>Total Spending</h3>
                <p class="amount" id="totalSpending">$0.00</p>
                <small>This month</small>
            </div>
            <div class="card">
                <h3>Transactions</h3>
                <p class="amount" id="totalTransactions">0</p>
                <small>This month</small>
            </div>
            <div class="card">
                <h3>Select Month</h3>
                <input type="month" id="monthSelector" class="month-input">
            </div>
        </div>

        <!-- Charts -->
        <div class="charts-container">
            <div class="chart-card">
                <h3>Spending by Category</h3>
                <canvas id="categoryChart"></canvas>
            </div>
            <div class="chart-card">
                <h3>Monthly Trend</h3>
                <canvas id="trendChart"></canvas>
            </div>
        </div>

        <!-- Transactions List -->
        <div class="transactions-container">
            <h3>Recent Transactions</h3>
            <div id="transactionsList"></div>
        </div>
    </div>

    <script>
        let expenses = [];
        let categoryChart = null;
        let trendChart = null;
        let isEditMode = false;

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            const today = new Date();
            document.getElementById('date').valueAsDate = today;
            document.getElementById('monthSelector').value = today.toISOString().slice(0, 7);

            document.getElementById('addBtn').addEventListener('click', showAddForm);
            document.getElementById('monthSelector').addEventListener('change', updateDisplay);

            loadExpenses();
        });

        function showAddForm() {
            isEditMode = false;
            document.getElementById('formTitle').textContent = 'New Expense';
            document.getElementById('saveBtn').textContent = 'Add Expense';
            document.getElementById('editExpenseId').value = '';
            document.getElementById('amount').value = '';
            document.getElementById('category').value = 'Food & Dining';
            document.getElementById('description').value = '';
            document.getElementById('date').valueAsDate = new Date();
            document.getElementById('expenseForm').style.display = 'block';
        }

        function showEditForm(expense) {
            isEditMode = true;
            document.getElementById('formTitle').textContent = 'Edit Expense';
            document.getElementById('saveBtn').textContent = 'Update Expense';
            document.getElementById('editExpenseId').value = expense.id;
            document.getElementById('amount').value = expense.amount;
            document.getElementById('category').value = expense.category;
            document.getElementById('description').value = expense.description;
            document.getElementById('date').value = expense.date;
            document.getElementById('expenseForm').style.display = 'block';
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function cancelForm() {
            document.getElementById('expenseForm').style.display = 'none';
            isEditMode = false;
        }

        async function loadExpenses() {
            const response = await fetch('/api/expenses');
            expenses = await response.json();
            updateDisplay();
        }

        async function saveExpense() {
            const amount = document.getElementById('amount').value;
            const category = document.getElementById('category').value;
            const description = document.getElementById('description').value;
            const date = document.getElementById('date').value;

            if (!amount || !description || !date) {
                alert('Please fill in all fields');
                return;
            }

            const expense = { amount, category, description, date };

            if (isEditMode) {
                // Update existing expense
                const expenseId = document.getElementById('editExpenseId').value;
                const response = await fetch(`/api/expenses/${expenseId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(expense)
                });

                if (response.ok) {
                    cancelForm();
                    await loadExpenses();
                }
            } else {
                // Add new expense
                const response = await fetch('/api/expenses', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(expense)
                });

                if (response.ok) {
                    cancelForm();
                    await loadExpenses();
                }
            }
        }

        async function deleteExpense(id) {
            if (confirm('Are you sure you want to delete this expense?')) {
                await fetch(`/api/expenses/${id}`, { method: 'DELETE' });
                await loadExpenses();
            }
        }

        function editExpense(id) {
            const expense = expenses.find(e => e.id === id);
            if (expense) {
                showEditForm(expense);
            }
        }

        function updateDisplay() {
            const selectedMonth = document.getElementById('monthSelector').value;
            const filtered = expenses.filter(e => e.date.startsWith(selectedMonth));

            // Update summary
            const total = filtered.reduce((sum, e) => sum + parseFloat(e.amount), 0);
            document.getElementById('totalSpending').textContent = `$${total.toFixed(2)}`;
            document.getElementById('totalTransactions').textContent = filtered.length;

            // Update transactions list
            displayTransactions(filtered);

            // Update charts
            updateCharts(filtered);
        }

        function displayTransactions(filtered) {
            const list = document.getElementById('transactionsList');

            if (filtered.length === 0) {
                list.innerHTML = '<p class="no-data">No expenses for this month. Start tracking!</p>';
                return;
            }

            list.innerHTML = filtered.sort((a, b) => new Date(b.date) - new Date(a.date))
                .map(e => `
                    <div class="transaction-item">
                        <div class="transaction-info">
                            <div>
                                <strong>${e.description}</strong>
                                <span class="category-badge">${e.category}</span>
                            </div>
                            <small>${e.date}</small>
                        </div>
                        <div class="transaction-actions">
                            <strong>$${parseFloat(e.amount).toFixed(2)}</strong>
                            <button onclick="editExpense(${e.id})" class="btn-edit">Edit</button>
                            <button onclick="deleteExpense(${e.id})" class="btn-delete">Delete</button>
                        </div>
                    </div>
                `).join('');
        }

        function updateCharts(filtered) {
            // Category Chart
            const categories = {};
            filtered.forEach(e => {
                categories[e.category] = (categories[e.category] || 0) + parseFloat(e.amount);
            });

            const categoryData = {
                labels: Object.keys(categories),
                datasets: [{
                    data: Object.values(categories),
                    backgroundColor: [
                        '#0088FE', '#00C49F', '#FFBB28', '#FF8042',
                        '#8884D8', '#82CA9D', '#FFC658', '#FF6B9D'
                    ]
                }]
            };

            if (categoryChart) categoryChart.destroy();
            const ctx1 = document.getElementById('categoryChart').getContext('2d');
            categoryChart = new Chart(ctx1, {
                type: 'doughnut',
                data: categoryData,
                options: {
                    responsive: true,
                    plugins: {
                        legend: { position: 'bottom' }
                    }
                }
            });

            // Monthly Trend Chart
            const months = {};
            expenses.forEach(e => {
                const month = e.date.slice(0, 7);
                months[month] = (months[month] || 0) + parseFloat(e.amount);
            });

            const sortedMonths = Object.keys(months).sort().slice(-6);
            const trendData = {
                labels: sortedMonths,
                datasets: [{
                    label: 'Monthly Spending',
                    data: sortedMonths.map(m => months[m]),
                    backgroundColor: '#8884D8'
                }]
            };

            if (trendChart) trendChart.destroy();
            const ctx2 = document.getElementById('trendChart').getContext('2d');
            trendChart = new Chart(ctx2, {
                type: 'bar',
                data: trendData,
                options: {
                    responsive: true,
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });
        }
    </script>
</body>
</html>